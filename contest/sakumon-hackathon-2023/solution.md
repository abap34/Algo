$$
L(a, b) =\sum_{i=1}^n  \ \min \left\{ \left( y_i - f(x_i) \right)^2, \left( y_i - g(x_i) \right)^2 \right\}
$$

は、このままで最小化を行うのは難しいです。

そのため、
各$(x_i, y_i)$について、

$y_i - f(x_i)$ と $y_i - g(x_i)$

のうちどちらが小さい方になるか決め打つことを考えます。

(これ以降では、$(x_i, y_i)$ が、
 $y_i - f(x_i) \leq y_i - g(x_i)$ を満たすとき、
 $(x_i, y_i)$ は $f$ に「属する」と表現します。 これを満たさないとき、 $(x_i, y_i)$ は $g$ に「属する」と表現します。したがって全ての点はどちらかに属します。)


最も簡単な方法は、ビット全探索を用いて、$N$個の点について、それぞれの点がどちらの直線に属するかを決め打ちする方法です。
ですが、この方法では調べる割り当ては$2^N$通りあり、今回の制約でこれを全て調べることは難しいです。



## $L$を最小にする二つの直線が、 $[0, x_{\max}]$ で交わらないとき

ここからは列挙する割り当てを少なくしていくことを考えます。

まず、簡単のために、二つの直線が、 $[0,\ x_{\max}]$ で交わらないときを考えてみます。 ($x_{\max}$ は $x$ 座標の最大値)

すると、この仮定のもとでは実は $N$ 通りだけを調べれば良いです。

各点がどちらの直線に属するかの境界となる直線 $l$ を考えます。

$l$ は、その定義から
$f$ と $g$ の交点と、
$\left( 0, \dfrac{W}{2} \right)$ を通リます。

なので、 $f$ と $g$ の交点の $y$ 座標を 十分大きい値から十分小さい値まで変化させると、

$\left( 0, \dfrac{W}{2} \right)$ から引いた直線の傾きの大きさの順に点が $g$ へ属することになります。

したがって、$\left( 0, \dfrac{W}{2} \right)$からの傾きを事前に調べておき、

最初に全ての点を $f$ に割り当てたあと、この傾きの小さい順に点を $g$ に割り当てていけば十分であることがわかります。


## 交わる場合

二つの直線が、 $[0,\ x_{\max}]$ で交わる場合を考えます。

二つの直線が交わることで境界を定める $l$ がどのように変化するかを考えると、

交点の $x$ 座標を $x_p$ としたとき

- $x_i < x_p$ なる $(x_i, y_i)$
  - 交わらないと仮定したときと同様、 $l$ の上側なら $f$、 $l$ の下側なら $g$ に属する。
- $x \geq x_p$ なる $(x_i, y_i)$
  - $l$ の上側なら $g$ 、$l$ の下側なら $f$ に属する。

となります。

したがって、
$x_p$ さえ決まれば、属する直線が決められます。

そして、問題になるのは各 $(x_i, y_i)$ との大小関係のみなので、
$x_p$ は全ての $x_i$ を試せば十分です。

よって、全ての組み合わせを調べるには、

$\left( 0, \dfrac{W}{2} \right)$からの傾きから順に割り当てたあと、

$x_i$ の大きい順にその割り当てを「反転」($f$ に属していれば $g$に、　$g$ に属していれば $f$ に)していけば十分です。

こうして、調べる組み合わせは $O(N^2)$ になります。


## $L$ の計算

属する直線さえ決まれば、 最小化したい $L$ は、

$f$ に属する点の集合を $U$, $g$ に属する点の集合を $D$ とすると、

$$
L(a_1, a_2) = \sum_{(x_i, y_i) \in U} \left( y_i - f(x_i) \right)^2 + \sum_{(x_i, y_i) \in D} \left( y_i - g(x_i) \right)^2
$$


となり、 $\sum_{(x_i, y_i) \in U} \left( y_i - f(x_i) \right)^2$ と $\sum_{(x_i, y_i) \in D} \left( y_i - g(x_i) \right)^2$ はそれぞれ $a_1, a_2$ のみの関数になり、独立に最小化して和をとれば $L$ も最小になります。


それぞれの最小化は、 

$$
\argmin_{a} \sum_i^N \left( y_i - ax_
i \right)^2
$$

のような問題を解けばよいです。
これは、

$$
\begin{aligned}
\sum_i^N \left( y_i - ax_i) \right)^2 &= \sum_i^N \left( y_i^2 - 2 a x_i y_i + a^2 x_i^2 \right) \\
&= \sum_i^N y_i^2 - 2 a \sum_i^N x_i y_i + a^2 \sum_i^N x_i^2
\end{aligned}
$$

と変形すれば、下に凸な二次関数であることがわかります。

よって、これを最小にする $a$ は、

$$
a = \dfrac{\sum_i^N x_i y_i}{\sum_i^N x_i^2}
$$

となり、これは $O(N)$ で求めることができます。

なので、この $a$ を $\sum_i^N \left( y_i - ax_i \right)^2$ に代入すれば、 $O(N)$ で $L$ を求めることができます。

これを各割り当てごとに計算すれば、全ての調べる組み合わせについて $L$ がもとまり、全体で $O(N^3)$ の計算量で解くことができますが、より高速化することができます。


$\left( 0, \dfrac{W}{2} \right)$ からの傾きから順に割り当てたあと、


$$
\begin{gathered}
S_{xy}^D = \sum_{(x_i, y_i) \in D} x_i y_i \\
S_{x^2}^D = \sum_{(x_i, y_i) \in D} x_i^2 \\
S_{y^2}^D = \sum_{(x_i, y_i) \in D} y_i^2 \\
S_{xy}^U = \sum_{(x_i, y_i) \in U} x_i y_i \\
S_{x^2}^U = \sum_{(x_i, y_i) \in U} x_i^2 \\
S_{y^2}^U = \sum_{(x_i, y_i) \in U} y_i^2
\end{gathered}
$$

を計算しておきます。

すると、割り当てを反転させる点を変化させていくとき、その点について $x$ 座標の値と $y$ 座標の値の積及び二乗をそれぞれ加えるか引くかするだけで、 $S_{xy}^D, S_{x^2}^D, S_{y^2}^D, S_{xy}^U, S_{x^2}^U, S_{y^2}^U$ を更新することができます。

そして、この6つの値のみによって、 $O(1)$ で $L$ を計算することができるので、 反転させる点を変化させていくとき、各割り当てについて $L$ を $O(1)$ で計算することができます。

よって、全体として $O(N^2)$ で $L$ を計算することができます。

今回の制約上では、このアルゴリズムによって十分高速に解くことができます。



